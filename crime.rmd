```{r load library}
library(tidyverse)
library(tsbox)
library(xts)
library(rugarch)
library(tseries)
library(anytime)

usethis::create_project('E:/Textbook/4th Year/ISSC/Crime related')
```

## Load Data
```{r load data}
boston <- read.csv('boston.csv')
head(boston)

# add date
boston <- boston %>%
  mutate(date = substr(OCCURRED_ON_DATE, start = 1, stop = 10))


# boston before 2015
boston_2012 <- read.csv("boston before 2015.csv")
head(boston_2012)

# add date
#boston_2012 <- boston_2012 %>%
#  mutate(date = substr(OCCURRED_ON_DATE, start = 1, stop = 10))
```

## Non-plot exploration
```{r non-plot exploration}
# summary of all crime
boston_summary <- boston %>%
  group_by(OFFENSE_DESCRIPTION) %>%
  summarise(number_of_crime = n()) %>%
  arrange(desc(number_of_crime))

boston_summary

# count per month
boston_monthly <- boston %>%
  group_by(OFFENSE_DESCRIPTION, YEAR, MONTH) %>%
  summarize(monthly_freq = n())

# count per day
boston_daily <- boston %>%
  group_by(OFFENSE_DESCRIPTION, date) %>%
  summarize(daily_frequ = n())

```


```{r plot}
# bar chart of 5 most frequent crime over the years
boston %>%
  filter(OFFENSE_DESCRIPTION %in% head(boston_summary$OFFENSE_DESCRIPTION, 5)) %>%
  ggplot(aes(x=OFFENSE_DESCRIPTION)) +
  geom_bar()

# investigate person per month
investigate <- boston_monthly %>%
  ungroup() %>%
  select(OFFENSE_DESCRIPTION, YEAR, MONTH, monthly_freq) %>%
  filter(OFFENSE_DESCRIPTION == "SICK/INJURED/MEDICAL - PERSON")

# construct time
dates <- seq(as.Date("2015-06-01"), length = nrow(investigate), by = "months")
investigate$time <- dates

# reorder and select only interested columns
col_order <- c("time", "monthly_freq")
investigate_ts <- investigate[, col_order] %>%
  # remove May 2020 due to incomplete info
  head(-1) %>%
  ts_ts() 



# plot time series of investigate
ts_plot(investigate_ts, title="Number of SICK/INJURED/MEDICAL - PERSON cases per month in Boston")

# stationary?
adf.test(investigate_ts)

# try to detrend
investigate_diff <- diff(investigate_ts)
adf.test(investigate_diff)
ts_plot(investigate_diff, title = "Change in the number of sick/injured person cases per month in Boston")

investigate_xts <- investigate[, col_order] %>%
  # remove May 2020 due to incomplete info
  head(-1) %>%
  ts_xts() 

plot.xts(investigate_xts)

# plot daily version of calling medical attention
medical_daily <- boston_daily %>%
  ungroup() %>%
  filter(OFFENSE_DESCRIPTION == "SICK/INJURED/MEDICAL - PERSON") %>%
  select(date, daily_frequ)

colnames(medical_daily)[1] <- 'time'

medical_daily %>%
  ts_xts() %>%
  plot.xts(main = "number of calling medical attention per day in Boston")
```

```{r model building}
medical_xts <- ts_xts(medical_daily)
medical_diff_xts <- na.omit(diff(medical_xts))
plot.xts(medical_diff_xts)

model_arma_garch <- ugarchspec(variance.model = list(model = 'sGARCH', garchOrder = c(1,1)),
                           mean.model = list(armaOrder = c(1,0), include.mean = TRUE),
                           distribution.model = 'norm')

medical_var_fit <- ugarchfit(spec = model_arma_garch, data = medical_diff_xts)
medical_var_fit@fit$coef

# obtain in-sample forecast
medical_forecast <- ugarchforecast(fit = medical_var_fit, n.ahead = 20)

# plot fit
dates1 <- index(medical_diff_xts)
t1 <- start(medical_diff_xts)
medical_fit_xts <- xts(medical_forecast@model$modeldata$sigma, 
                      start = t1, order.by = anytime(dates1))

# plot fitted volatility
plot.xts(medical_fit_xts, grid.col = 'white',
         col = 'darkblue', ylab = '')
```