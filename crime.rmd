```{r load library}
library(tidyverse)
library(tsbox)
library(xts)
library(rugarch)
library(tseries)
library(anytime)
library(aTSA) # adf.test
```

## Load Data
```{r load data}
boston <- read.csv('boston.csv')
head(boston)

# add date
boston <- boston %>%
  mutate(date = substr(OCCURRED_ON_DATE, start = 1, stop = 10))

```

## Non-plot exploration
```{r non-plot exploration}
# summary of all crime
boston_summary <- boston %>%
  group_by(OFFENSE_DESCRIPTION) %>%
  summarise(number_of_crime = n()) %>%
  arrange(desc(number_of_crime))

boston_summary

# count per month
boston_monthly <- boston %>%
  group_by(OFFENSE_DESCRIPTION, YEAR, MONTH) %>%
  summarize(monthly_freq = n())

# count per day
boston_daily <- boston %>%
  group_by(OFFENSE_DESCRIPTION, date) %>%
  summarize(daily_frequ = n())

```


```{r plot}
# bar chart of 5 most frequent crime over the years
boston %>%
  filter(OFFENSE_DESCRIPTION %in% head(boston_summary$OFFENSE_DESCRIPTION, 5)) %>%
  ggplot(aes(x=OFFENSE_DESCRIPTION)) +
  geom_bar()

# verbal dispute per month
dispute <- boston_monthly %>%
  ungroup() %>%
  select(OFFENSE_DESCRIPTION, YEAR, MONTH, monthly_freq) %>%
  filter(OFFENSE_DESCRIPTION == "VERBAL DISPUTE")

# construct time
dates <- seq(as.Date("2015-06-01"), length = nrow(dispute), by = "months")
dispute$time <- dates

# reorder and select only interested columns
col_order <- c("time", "monthly_freq")
dispute_ts <- dispute[, col_order] %>%
  # remove May 2020 due to incomplete info
  head(-1) %>%
  ts_ts() 



# plot time series of investigate
ts_plot(dispute_ts, title="Number of VERBAL DISPUTE cases per month in Boston")

# stationary?
adf.test(dispute_ts)
# adf test result is stationary, no need for differentiating

# try to detrend
dispute_diff <- diff(dispute_ts)
adf.test(dispute_diff)
ts_plot(dispute_diff, title = "Change in the number of VERBAL DISPUTE cases per month in Boston")

dispute_xts <- dispute[, col_order] %>%
  # remove May 2020 due to incomplete info
  head(-1) %>%
  ts_xts() 

plot.xts(dispute_xts)

# plot daily version of verbal dispute
dispute_daily <- boston_daily %>%
  ungroup() %>%
  filter(OFFENSE_DESCRIPTION == "VERBAL DISPUTE") %>%
  select(date, daily_frequ)

colnames(dispute_daily)[1] <- 'time'

dispute_daily %>%
  ts_xts() %>%
  plot.xts(main = "number of VERBAL DISPUTE per day in Boston")
```

```{r model building}

# already stationary
# no need to do first difference to obtain stationarity
dispute_xts <- ts_xts(dispute_daily)
# following two steps are unnecessary
dispute_diff_xts <- na.omit(diff(dispute_xts))
plot.xts(dispute_diff_xts)

model_arma_garch <- ugarchspec(variance.model = list(model = 'sGARCH', garchOrder = c(1,1)),
                           mean.model = list(armaOrder = c(1,0), include.mean = TRUE),
                           distribution.model = 'norm')
# build model using original data since it is stationary already
dispute_var_fit <- ugarchfit(spec = model_arma_garch, data = dispute_xts)
dispute_var_fit@fit$coef

# obtain in-sample forecast
dispute_forecast <- ugarchforecast(fit = dispute_var_fit, n.ahead = 20)

# plot fit
dates1 <- index(dispute_xts)
t1 <- start(dispute_xts)
dispute_fit_xts <- xts(dispute_forecast@model$modeldata$sigma, 
                      start = t1, order.by = anytime(dates1))

# plot fitted volatility
plot.xts(dispute_fit_xts, grid.col = 'white',
         col = 'darkblue', ylab = '')
```
